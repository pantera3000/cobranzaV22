{% extends 'documentos/base.html' %}
{% load math_extras %}  <!-- ✅ Añade esta línea -->
{% load dict_extras %}  <!-- ✅ Añadido -->

{% block title %}Detalle de {{ documento.get_tipo_display }} {{ documento.numero }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-invoice"></i> Detalle del Documento</h2>
    <div>
        <!-- ✅ Botón: Volver atrás -->
        <button type="button" class="btn btn-outline-secondary me-2" onclick="window.history.back();">
            <i class="fas fa-arrow-left"></i> Volver
        </button>

        <!-- ✅ Botones de acción directa -->
        {% if documento.get_saldo_pendiente > 0 %}
            <a href="{% url 'cobros:cobro_create' %}?documento={{ documento.pk }}&next={{ request.get_full_path|urlencode }}"
               class="btn btn-success me-2">
                <i class="fas fa-money-bill-wave"></i> Agregar Pago
            </a>
            <a href="{% url 'devoluciones:devolucion_create' %}?documento={{ documento.pk }}&next={{ request.get_full_path|urlencode }}"
               class="btn btn-primary me-2">
                <i class="fas fa-undo"></i> Agregar Devolución
            </a>
        {% else %}
            <button class="btn btn-success me-2" disabled title="No hay saldo pendiente">
                <i class="fas fa-money-bill-wave"></i> Agregar Pago
            </button>
            <button class="btn btn-primary me-2" disabled title="No hay saldo pendiente">
                <i class="fas fa-undo"></i> Agregar Devolución
            </button>
        {% endif %}

        <!-- Otros botones -->
        <a href="{% url 'documentos:documento_list' %}" class="btn btn-secondary me-2">
            <i class="fas fa-list"></i> Todos
        </a>
        <a href="{% url 'documentos:documento_update' documento.pk %}" class="btn btn-warning">
            <i class="fas fa-edit"></i> Editar
        </a>
    </div>
</div>

<!-- Información principal -->
<!-- Información principal -->
<!-- Información principal -->
<div class="card mb-4
    {% if documento.get_estado == 'pagado' %}border-success bg-success bg-opacity-10
    {% elif documento.get_estado == 'vencido' %}border-danger bg-danger bg-opacity-10
    {% elif documento.get_estado == 'pago_parcial' %}border-info bg-info bg-opacity-10
    {% else %}border-warning bg-warning bg-opacity-10{% endif %}
">
    <!-- ✅ Encabezado con cliente destacado -->
    <div class="card-header
        {% if documento.get_estado == 'pagado' %}bg-success text-white
        {% elif documento.get_estado == 'vencido' %}bg-danger text-white
        {% elif documento.get_estado == 'pago_parcial' %}bg-info text-white
        {% else %}bg-warning text-dark{% endif %}
        d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
            <h5 class="mb-1"><i class="fas fa-info-circle"></i> Información del Documento</h5>
            <!-- ✅ Cliente en el encabezado -->
            <!-- ✅ Cliente como badge destacado y clickeable -->
            <div class="mt-1">
                <a href="{% url 'clientes:cliente_detail' documento.cliente.pk %}" 
                class="text-white text-decoration-none">
                    <span class="badge bg-primary px-3 py-2 rounded-4" 
                        style="font-size: 1rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-user-tie me-2"></i>
                        {{ documento.cliente.nombre }}
                    </span>
                </a>
            </div>
        </div>
        <!-- Estado en la derecha -->
        <!-- Estado en la derecha -->
        <span class="
            badge 
            fs-5 
            px-4 
            py-2 
            rounded-pill 
            fw-bold
            {% if documento.get_estado == 'pagado' %}
                bg-success text-white
            {% elif documento.get_estado == 'vencido' %}
                bg-danger text-white
            {% elif documento.get_estado == 'pago_parcial' %}
                bg-info text-white
            {% else %}
                bg-warning text-dark
            {% endif %}
        ">
            {{ documento.get_estado_display }}
        </span>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Tipo:</strong> {{ documento.get_tipo_display }}</p>
                <p><strong>Número:</strong> {{ documento.serie }}-{{ documento.numero }}</p>
                <p><strong>Cobrador:</strong>
                    {% if documento.cobrador %}
                        <a href="{% url 'cobradores:cobrador_detail' documento.cobrador.pk %}" 
                           class="text-decoration-none">
                            {{ documento.cobrador.nombre }}
                        </a>
                    {% else %}
                        <span class="text-muted">–</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6">
                <p><strong>Emisión:</strong> {{ documento.fecha_emision|date:"d/m/Y H:i" }} (Lima)</p>
                <p><strong>Vencimiento:</strong> {{ documento.fecha_vencimiento|date:"d/m/Y H:i" }} (Lima)</p>
            </div>
        </div>
    </div>
</div>


<!-- Barra de vencimiento -->
<!-- Barra de vencimiento -->
<!-- Barra de vencimiento -->
<div class="progress mb-4" 
     style="height: 45px; border-radius: 22px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">
    <div class="progress-bar 
        {% if documento.get_estado == 'pagado' %}
            bg-success  <!-- ✅ Verde para documentos pagados -->
        {% else %}
            {% with dias=documento.get_dias_restantes %}
                {% if dias < 0 %}
                    bg-danger
                {% elif dias == 0 %}
                    bg-warning text-dark
                {% elif dias <= 7 %}
                    bg-orange text-white
                {% elif dias <= 15 %}
                    bg-info text-white
                {% elif dias <= 30 %}
                    bg-primary
                {% else %}
                    bg-success
                {% endif %}
            {% endwith %}
        {% endif %}
        d-flex align-items-center justify-content-center"
        role="progressbar"
        style="width: 100%; font-weight: bold; font-size: 1rem; padding: 0 12px;">
        {% with dias=documento.get_dias_restantes %}
            {% if dias < 0 %}
                <i class="fas fa-exclamation-triangle me-2"></i> Vencido hace {{ dias|modulo }} día{{ dias|modulo|pluralize }}
            {% elif dias == 0 %}
                <i class="fas fa-clock me-2"></i> Vence HOY
            {% elif dias <= 7 %}
                <i class="fas fa-calendar-alt me-2"></i> Vence en {{ dias }} día{{ dias|pluralize }} (1-7 días)
            {% elif dias <= 15 %}
                <i class="fas fa-calendar-check me-2"></i> Vence en {{ dias }} día{{ dias|pluralize }} (8-15 días)
            {% elif dias <= 30 %}
                <i class="fas fa-calendar-week me-2"></i> Vence en {{ dias }} día{{ dias|pluralize }} (16-30 días)
            {% else %}
                <i class="fas fa-calendar-plus me-2"></i> Vence en {{ dias }} día{{ dias|pluralize }} (+31 días)
            {% endif %}
        {% endwith %}
    </div>
</div>

{% block extra_css %}
<style>
    .bg-orange {
        background-color: #ff7b00 !important;  /* Naranja fuerte */
        color: white !important;
    }
    .badge.bg-orange,
    .progress-bar.bg-orange {
        background-color: #ff7b00 !important;
        color: white !important;
    }
    .bg-orange.text-dark {
        color: white !important;
    }
</style>
{% endblock %}

<!-- Montos -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-money-bill-wave"></i> Montos (S/)</h5>
    </div>
    <div class="card-body">
        <div class="row text-center g-2">
            <div class="col-6 col-md-3">
                <div class="alert alert-primary mb-0">
                    <strong>Total</strong><br>
                    <span class="h5 mb-0">{{ documento.monto_total|floatformat:2 }}</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="alert alert-success mb-0">
                    <strong>Pagado</strong><br>
                    <span class="h5 mb-0">{{ documento.monto_pagado|floatformat:2 }}</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="alert alert-warning mb-0">
                    <strong>Devolución</strong><br>
                    <span class="h5 mb-0">{{ documento.monto_devolucion|floatformat:2 }}</span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="alert alert-danger mb-0">
                    <strong>Saldo</strong><br>
                    <span class="h5 mb-0">{{ documento.get_saldo_pendiente|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historial de movimientos -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-history"></i> Historial de Movimientos</h5>
    </div>

    <!-- Pestañas -->
    <ul class="nav nav-tabs nav-underline mb-4" id="historialTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center gap-2 px-3 py-2" 
                    id="cobros-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#cobros" 
                    type="button" 
                    role="tab">
                <i class="fas fa-money-bill-wave text-success"></i>
                <span class="text-success">Pagos</span>
                <span class="badge bg-success rounded-pill" style="font-size: 0.85em;">
                    {{ cobros.paginator.count }}
                </span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2 px-3 py-2" 
                    id="devoluciones-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#devoluciones" 
                    type="button" 
                    role="tab">
                <i class="fas fa-undo text-danger"></i>
                <span class="text-danger">Devoluciones</span>
                <span class="badge bg-danger text-white rounded-pill" style="font-size: 0.85em;">
                    {{ devoluciones.paginator.count }}
                </span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="historialTabsContent">
        <!-- Pagos -->
        <div class="tab-pane fade show active" id="cobros" role="tabpanel" aria-labelledby="cobros-tab">
            {% if cobros %}
                <!-- Escritorio: Tabla -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Monto</th>
                                    <th>Cobrador</th>
                                    <th>Referencia</th>
                                    <th>Notas</th>
                                    <th>Fecha Pago</th>
                                    <th>Registrado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cobro in cobros %}
                                <tr>
                                    <td><strong>S/ {{ cobro.monto|floatformat:2 }}</strong></td>
                                    <td>
                                        <a href="{% url 'cobradores:cobrador_detail' cobro.cobrador.pk %}" 
                                           class="text-decoration-none">
                                            {{ cobro.cobrador.nombre }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if cobro.referencia %}
                                            <a href="{% url 'cobros:buscar_por_referencia' %}?q={{ cobro.referencia|urlencode }}"
                                            class="d-inline-flex align-items-center gap-2 text-decoration-none">
                                                <span class="badge bg-primary text-white px-3 py-1" 
                                                    style="font-size: 0.85em; border-radius: 20px; font-weight: 500;">
                                                    {{ cobro.referencia }}
                                                </span>
                                                <span class="badge bg-light text-primary border border-primary px-2 py-1" 
                                                    style="font-size: 0.75em; border-radius: 12px;">
                                                    {{ referencia_count|get_item:cobro.referencia }} doc
                                                </span>
                                            </a>
                                        {% else %}
                                            <span class="text-muted">–</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cobro.notas %}
                                            <small class="text-muted">{{ cobro.notas|linebreaksbr|truncatechars:60 }}</small>
                                        {% else %}
                                            <span class="text-muted">–</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ cobro.fecha|date:"d/m/Y H:i" }}</td>
                                    <td class="text-muted">{{ cobro.creado_en|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Móvil: Tarjetas -->
                <div class="d-md-none">
                    {% for cobro in cobros %}
                    <div class="card border mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1 text-success">
                                        <i class="fas fa-money-bill-wave"></i> Pago
                                    </h6>
                                    <p class="mb-1">
                                        <strong>Monto:</strong> S/ {{ cobro.monto|floatformat:2 }}
                                    </p>
                                </div>
                                <span class="badge bg-success rounded-pill px-3 py-2" style="font-size: 0.85em;">
                                    {{ cobro.fecha|date:"d/m" }}
                                </span>
                            </div>

                            <p class="mb-1">
                                <strong>Cobrador:</strong> 
                                <a href="{% url 'cobradores:cobrador_detail' cobro.cobrador.pk %}" 
                                   class="text-decoration-none">
                                    {{ cobro.cobrador.nombre }}
                                </a>
                            </p>
                            {% if cobro.referencia %}
                                <p class="mb-1">
                                    <strong>Referencia:</strong>
                                    <a href="{% url 'cobros:buscar_por_referencia' %}?q={{ cobro.referencia|urlencode }}"
                                    class="d-inline-flex align-items-center gap-2 text-decoration-none">
                                        <span class="badge bg-primary text-white px-3 py-1" 
                                            style="font-size: 0.85em; border-radius: 20px; font-weight: 500;">
                                            {{ cobro.referencia }}
                                        </span>
                                        <span class="badge bg-light text-primary border border-primary px-2 py-1" 
                                            style="font-size: 0.75em; border-radius: 12px;">
                                            {{ referencia_count|get_item:cobro.referencia }} doc
                                        </span>
                                    </a>
                                </p>
                            {% endif %}
                            {% if cobro.notas %}
                            <p class="mb-1">
                                <strong>Notas:</strong> 
                                <small class="text-muted">{{ cobro.notas|truncatechars:60 }}</small>
                            </p>
                            {% endif %}
                            <p class="mb-0 text-muted">
                                <small>Registrado: {{ cobro.creado_en|date:"d/m/Y H:i" }}</small>
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Paginación -->
                {% if cobros.has_other_pages %}
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if cobros.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?cobros_page={{ cobros.previous_page_number }}">
                                &laquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}

                        {% for num in cobros.paginator.page_range %}
                        <li class="page-item {% if num == cobros.number %}active{% endif %}">
                            <a class="page-link" href="?cobros_page={{ num }}">
                                {{ num }}
                            </a>
                        </li>
                        {% endfor %}

                        {% if cobros.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?cobros_page={{ cobros.next_page_number }}">
                                &raquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-money-bill-wave fa-2x mb-2"></i><br>
                    <small>No hay pagos registrados.</small>
                </div>
            {% endif %}
        </div>

        <!-- Devoluciones -->
        <!-- Devoluciones -->
        <div class="tab-pane fade" id="devoluciones" role="tabpanel" aria-labelledby="devoluciones-tab">
            {% if devoluciones %}
                <!-- Escritorio: Tabla -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Monto</th>
                                    <th>Cobrador</th>
                                    <th>Notas</th>  <!-- ✅ Nueva columna -->
                                    <th>Fecha</th>
                                    <th>Registrado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dev in devoluciones %}
                                <tr>
                                    <!-- <td><strong>S/ {{ dev.monto|floatformat:2 }}</strong></td> -->
                                    <td><strong class="text-danger fw-bold">S/ {{ dev.monto|floatformat:2 }}</strong></td>




                                    <td>
                                        <a href="{% url 'cobradores:cobrador_detail' dev.cobrador.pk %}" 
                                        class="text-decoration-none">
                                            {{ dev.cobrador.nombre }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if dev.notas %}
                                            <small class="text-muted">{{ dev.notas|linebreaksbr|truncatechars:60 }}</small>
                                        {% else %}
                                            <span class="text-muted">–</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ dev.fecha|date:"d/m/Y H:i" }}</td>
                                    <td class="text-muted">{{ dev.creado_en|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Móvil: Tarjetas -->
                <div class="d-md-none">
                    {% for dev in devoluciones %}
                    <div class="card border mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1 text-warning">
                                        <i class="fas fa-undo"></i> Devolución
                                    </h6>
                                    <p class="mb-1">
                                        <strong>Monto:</strong> <span class="text-danger">S/ {{ dev.monto|floatformat:2 }}</span>
                                    </p>
                                </div>
                                <span class="badge bg-warning text-dark rounded-pill px-3 py-2" style="font-size: 0.85em;">
                                    {{ dev.fecha|date:"d/m" }}
                                </span>
                            </div>

                            <p class="mb-1">
                                <strong>Cobrador:</strong> 
                                <a href="{% url 'cobradores:cobrador_detail' dev.cobrador.pk %}" 
                                class="text-decoration-none">
                                    {{ dev.cobrador.nombre }}
                                </a>
                            </p>

                            <!-- ✅ Notas (móvil) -->
                            {% if dev.notas %}
                                <p class="mb-1">
                                    <strong>Notas:</strong> 
                                    <small class="text-muted">{{ dev.notas|truncatechars:60 }}</small>
                                </p>
                            {% endif %}

                            <p class="mb-0 text-muted">
                                <small>Registrado: {{ dev.creado_en|date:"d/m/Y H:i" }}</small>
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Paginación -->
                {% if devoluciones.has_other_pages %}
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if devoluciones.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?devoluciones_page={{ devoluciones.previous_page_number }}">
                                &laquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}

                        {% for num in devoluciones.paginator.page_range %}
                        <li class="page-item {% if num == devoluciones.number %}active{% endif %}">
                            <a class="page-link" href="?devoluciones_page={{ num }}">
                                {{ num }}
                            </a>
                        </li>
                        {% endfor %}

                        {% if devoluciones.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?devoluciones_page={{ devoluciones.next_page_number }}">
                                &raquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-undo fa-2x mb-2"></i><br>
                    <small>No hay devoluciones registradas.</small>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}