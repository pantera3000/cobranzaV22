{% extends 'cobros/base.html' %}

{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

<!-- üî¥ DEBUG: Muestra los datos recibidos -->
<pre style="background:#f8f9fa; padding:10px; margin:10px 0; border:1px solid #ddd; font-size:12px;">
DEBUG: documento_inicial = {{ documento_inicial }}
DEBUG: documento_inicial_data = {{ documento_inicial_data }}
</pre>
<!-- üî¥ FIN DEBUG -->

{% block extra_css %}
<style>
    #documento-container {
        position: relative;
    }
    #documento-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .result-item:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-money-bill-wave"></i> {{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <!-- ‚úÖ Campo oculto para redirigir despu√©s de guardar -->
                    <input type="hidden" name="next" value="{{ request.GET.next|default:'' }}">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Campo de b√∫squeda -->
                            <div class="mb-3">
                                <label for="search-documento" class="form-label">Documento a pagar</label>
                                <input
                                    type="text"
                                    id="search-documento"
                                    class="form-control"
                                    placeholder="Buscar documento pendiente..."
                                    value=""
                                >
                                <div id="documento-results"></div>
                                <!-- Campo oculto para el ID -->
                                <input type="hidden" name="documento" id="documento-id" value="">
                            </div>

                            {{ form.cobrador|as_crispy_field }}
                            {{ form.fecha|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.monto|as_crispy_field }}

                            <!-- ‚úÖ Campo Notas Adicionales -->
                            <div class="mb-3">
                                <label for="{{ form.notas.id_for_label }}" class="form-label">{{ form.notas.label }}</label>
                                {{ form.notas }}
                                    <small id="notas-counter" class="text-muted d-block text-end mt-1">0/60</small>
                                {% if form.notas.help_text %}
                                    <small class="form-text text-muted">{{ form.notas.help_text }}</small>
                                {% endif %}
                                {% for error in form.notas.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <!-- Mostrar info del documento seleccionado -->
                            <div id="documento-info" class="mt-3" style="display: none;">
                                <strong>Cliente:</strong> <span id="info-cliente"></span><br>
                                <strong>DNI:</strong> <span id="info-dni"></span><br>
                                <strong>Monto Total:</strong> S/ <span id="info-total"></span><br>
                                <strong>Saldo Pendiente:</strong> S/ <span id="info-saldo"></span>
                            </div>
                        </div>
                    </div>
                    <!-- Campo oculto para next -->
                    <input type="hidden" name="next" value="{{ request.GET.next|default:'' }}">

                    <div class="d-flex justify-content-between mt-3">
                        <!-- Bot√≥n Volver din√°mico -->
                        {% if request.GET.next %}
                            <a href="{{ request.GET.next }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                        {% else %}
                            <a href="{% url 'cobros:cobro_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                        {% endif %}
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Registrar Pago
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ Script JSON manual (fuerza la generaci√≥n) -->
{% if documento_inicial_data %}
<script type="application/json" id="documento-inicial-data">
    {{ documento_inicial_data|safe }}
</script>
{% else %}
<script type="application/json" id="documento-inicial-data">
    null
</script>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('‚úÖ DOM cargado');

    const dataEl = document.getElementById('documento-inicial-data');
    console.log('üîç Elemento JSON:', dataEl);

    if (dataEl && dataEl.textContent && dataEl.textContent !== 'null') {
        try {
            const doc = JSON.parse(dataEl.textContent);
            console.log('üìÑ Documento inicial:', doc);

            const searchInput = document.getElementById('search-documento');
            const documentoId = document.getElementById('documento-id');

            searchInput.value = `${doc.tipo_display} ${doc.numero_completo} - ${doc.cliente_nombre}`;
            documentoId.value = doc.id;

            console.log('‚úÖ Campos llenados:', searchInput.value, documentoId.value);

            document.getElementById('info-cliente').textContent = doc.cliente_nombre;
            document.getElementById('info-dni').textContent = doc.cliente_dni;
            document.getElementById('info-total').textContent = doc.monto_total.toFixed(2);
            document.getElementById('info-saldo').textContent = doc.saldo_pendiente.toFixed(2);
            document.getElementById('documento-info').style.display = 'block';
        } catch (e) {
            console.error('‚ùå Error al cargar documento inicial:', e);
        }
    } else {
        console.warn('‚ö†Ô∏è No hay documento inicial o est√° vac√≠o');
    }

    // ‚úÖ B√∫squeda din√°mica (tu c√≥digo existente)
    const searchInput = document.getElementById('search-documento');
    const resultsBox = document.getElementById('documento-results');
    const documentoId = document.getElementById('documento-id');
    const documentoInfo = document.getElementById('documento-info');
    const infoCliente = document.getElementById('info-cliente');
    const infoDni = document.getElementById('info-dni');
    const infoTotal = document.getElementById('info-total');
    const infoSaldo = document.getElementById('info-saldo');

    searchInput.addEventListener('input', function () {
        const query = searchInput.value.trim();
        if (query.length < 2) {
            resultsBox.style.display = 'none';
            return;
        }

        fetch(`{% url 'documentos:documento_pendiente_autocomplete' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsBox.innerHTML = '';
                if (data.results.length === 0) {
                    const div = document.createElement('div');
                    div.className = 'result-item disabled';
                    div.textContent = 'No se encontraron documentos pendientes';
                    resultsBox.appendChild(div);
                } else {
                    data.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.textContent = item.text;
                        div.dataset.id = item.id;
                        div.dataset.cliente = item.cliente;
                        div.dataset.dni = item.dni_ruc;
                        div.dataset.total = item.monto_total;
                        div.dataset.saldo = item.saldo;
                        div.addEventListener('click', function () {
                            searchInput.value = item.text;
                            documentoId.value = item.id;
                            resultsBox.style.display = 'none';
                            infoCliente.textContent = item.cliente;
                            infoDni.textContent = item.dni_ruc;
                            infoTotal.textContent = parseFloat(item.monto_total).toFixed(2);
                            infoSaldo.textContent = parseFloat(item.saldo).toFixed(2);
                            documentoInfo.style.display = 'block';
                        });
                        resultsBox.appendChild(div);
                    });
                }
                resultsBox.style.display = 'block';
            })
            .catch(err => console.error('Error:', err));
    });

    // ‚úÖ Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
            resultsBox.style.display = 'none';
        }
    });

    // ‚úÖ Contador de caracteres para el campo "notas"
    const notasInput = document.getElementById('{{ form.notas.id_for_label }}');
    const counter = document.getElementById('notas-counter');
    
    if (notasInput && counter) {
        // Mostrar longitud inicial
        counter.textContent = notasInput.value.length + '/60';
        
        // Actualizar al escribir
        notasInput.addEventListener('input', function () {
            counter.textContent = this.value.length + '/60';
        });
    }
});
</script>
{% endblock %}