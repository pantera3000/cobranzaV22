{% extends 'base.html' %}

{% block title %}Pago Múltiple de Documentos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-handshake"></i> Pago Múltiple (Planilla)</h2>

    <!-- Contenedor para agrupar botones -->
    <div class="d-flex">
        <button type="button" class="btn btn-outline-secondary me-2" onclick="window.history.back();">
            <i class="fas fa-arrow-left"></i> Volver
        </button>

        <a href="{% url 'cobros:cobro_list' %}" class="btn btn-secondary">
            <i class="fas fa-list"></i> Ver Pagos
        </a>
    </div>
</div>


<div class="row">
    <!-- Columna izquierda: Búsqueda -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-search"></i> Buscar Documentos
            </div>
            <div class="card-body">
                <form method="get" class="mb-3">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control" placeholder="Buscar por cliente, número..." value="{{ query }}" autofocus>
                        <button class="btn btn-primary" type="submit">Buscar</button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Documento</th>
                                <th>Saldo</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documentos %}
                            <tr>
                                <td>{{ doc.cliente.nombre|truncatechars:20 }}</td>
                                <td>{{ doc.get_tipo_display }} {{ doc.get_numero_completo }}</td>
                                <td>S/ {{ doc.get_saldo_pendiente|floatformat:2 }}</td>
                                <td>
                                    <button class="btn btn-sm btn-success add-doc" 
                                            data-id="{{ doc.pk }}"
                                            data-cliente="{{ doc.cliente.pk }}"
                                            data-nombre="{{ doc.cliente.nombre }}"
                                            data-tipo="{{ doc.get_tipo_display }}"
                                            data-numero="{{ doc.get_numero_completo }}"
                                            data-saldo="{{ doc.get_saldo_pendiente }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    {% if query %}
                                        <i class="fas fa-search fa-lg text-muted mb-2"></i><br>
                                        No se encontraron documentos con saldo pendiente para "<strong>{{ query }}</strong>".
                                    {% else %}
                                        <i class="fas fa-file-invoice fa-lg text-muted mb-2"></i><br>
                                        Ingresa un término de búsqueda para ver documentos con saldo pendiente.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                {% if documentos.has_other_pages %}
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if documentos.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query|urlencode }}&page={{ documentos.previous_page_number }}">
                                &laquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}

                        {% for num in documentos.paginator.page_range %}
                        <li class="page-item {% if num == documentos.number %}active{% endif %}">
                            <a class="page-link" href="?q={{ query|urlencode }}&page={{ num }}">{{ num }}</a>
                        </li>
                        {% endfor %}

                        {% if documentos.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query|urlencode }}&page={{ documentos.next_page_number }}">
                                &raquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna derecha: Documentos seleccionados -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-shopping-cart"></i> Documentos a Pagar</span>
                <button type="button" class="btn btn-light btn-sm" id="clear-all">Limpiar Todo</button>
            </div>
            <div class="card-body">
                <form id="form-pagos">
                    {% csrf_token %}
                    <!-- Campo para número o referencia del pago múltiple -->
                    <div class="mb-3">
                        <label for="referencia">Número de Operación / Referencia / Planilla:</label>
                        <input type="text" 
                            name="referencia" 
                            id="referencia" 
                            class="form-control form-control-sm"
                            placeholder="Ej: LOTE-001, RECIBO-2025-123"
                            maxlength="50"
                            required>
                        <div class="invalid-feedback">
                            Debes ingresar un número de operación o referencia.
                        </div>
                        <small class="text-muted">Requerido: para tu control interno.</small>
                    </div>
                    <div class="mb-3">
                        <label>Cobrador:</label>
                        <select name="cobrador" class="form-select" required>
                            <option value="">Seleccionar cobrador</option>
                            {% for cobrador in cobradores %}
                            <option value="{{ cobrador.pk }}">{{ cobrador.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="lista-pagos" class="mb-3">
                        <!-- Aquí se añaden los pagos -->
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-shopping-cart fa-lg mb-2"></i><br>
                            No hay documentos seleccionados.
                        </div>
                    </div>


                    <!-- Campo Notas (Pago Múltiple) -->
                    <!-- Campo Notas (Pago Múltiple) -->
                    <div class="mb-3">
                        <label for="id_notas">Notas Adicionales (opcional)</label>
                        <textarea 
                            name="notas" 
                            id="id_notas" 
                            class="form-control form-control-sm"
                            rows="3"
                            maxlength="60"
                            placeholder="Información extra sobre estos pagos... (opcional)"></textarea>
                        <small class="text-muted">Esta nota se aplicará a todos los pagos registrados.</small>
                        <small id="notas-counter" class="text-muted d-block text-end mt-1">0/60</small>
                    </div>




                    <button type="submit" class="btn btn-success w-100" id="btn-registrar">
                        <i class="fas fa-check-circle"></i> Registrar Pagos
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const listaPagos = document.getElementById('lista-pagos');
    const formPagos = document.getElementById('form-pagos');
    
    // ✅ Cargar pagos desde sessionStorage
    let pagos = JSON.parse(sessionStorage.getItem('pagos_multiple')) || [];

    // ✅ Función para guardar en sessionStorage
    function guardarPagos() {
        sessionStorage.setItem('pagos_multiple', JSON.stringify(pagos));
    }

    // ✅ Función para actualizar lista
    function actualizarLista() {
        if (pagos.length === 0) {
            listaPagos.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-shopping-cart fa-lg mb-2"></i><br>
                    No hay documentos seleccionados.
                </div>`;
            return;
        }

        listaPagos.innerHTML = '';
        pagos.forEach((pago, index) => {
            const inputId = `pago_${pago.id}`;
            listaPagos.innerHTML += `
                <div class="card mb-2 border">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${pago.tipo} ${pago.numero}</strong><br>
                                <small>${pago.nombre}</small><br>
                                <small>Saldo: S/ ${pago.saldo.toFixed(2)}</small>
                            </div>
                            <div class="text-end">
                                <input type="number" step="0.01" min="0" max="${pago.saldo}" 
                                    id="${inputId}" name="pago_${pago.id}" 
                                    value="" 
                                    placeholder="0.00"
                                    class='form-control form-control-sm mb-1' 
                                    style='width: 100px; display: inline-block;'>
                                <button type="button" class="btn btn-sm btn-danger" 
                                        onclick="eliminarPago(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
    }

    // ✅ Mostrar pagos al cargar
    actualizarLista();

    // ✅ Añadir documento
    document.querySelectorAll('.add-doc').forEach(btn => {
        btn.addEventListener('click', function () {
            const id = this.dataset.id;
            const cliente = this.dataset.cliente;
            const nombre = this.dataset.nombre;
            const tipo = this.dataset.tipo;
            const numero = this.dataset.numero;
            const saldo = parseFloat(this.dataset.saldo);

            // Evitar duplicados
            if (pagos.some(p => p.id == id)) {
                alert('Documento ya agregado.');
                return;
            }

            pagos.push({ id, cliente, nombre, tipo, numero, saldo });
            actualizarLista();
            guardarPagos(); // ✅ Guardar
        });
    });

    // ✅ Eliminar pago
    window.eliminarPago = function(index) {
        pagos.splice(index, 1);
        actualizarLista();
        guardarPagos(); // ✅ Guardar
    };

    // ✅ Limpiar todo
    document.getElementById('clear-all').addEventListener('click', function () {
        pagos = [];
        actualizarLista();
        sessionStorage.removeItem('pagos_multiple');
    });

    // ✅ Enviar pagos
    formPagos.addEventListener('submit', function (e) {
        e.preventDefault();

        if (pagos.length === 0) {
            alert('Agrega al menos un documento.');
            return;
        }

        const cobrador = formPagos.cobrador.value;
        if (!cobrador) {
            alert('Selecciona un cobrador.');
            return;
        }

        // ✅ Validar que la referencia no esté vacía
        const referenciaInput = formPagos.referencia;
        if (!referenciaInput.value.trim()) {
            referenciaInput.classList.add('is-invalid');
            alert('Por favor, ingresa un número de operación o referencia.');
            return;
        } else {
            referenciaInput.classList.remove('is-invalid');
        }

        const formData = new FormData();
        formData.append('cobrador', cobrador);
        formData.append('referencia', referenciaInput.value.trim());

        // ✅ Obtener y añadir notas
        const notasInput = document.getElementById('id_notas');
        const notas = notasInput ? notasInput.value : '';
        formData.append('notas', notas);

        pagos.forEach(pago => {
            const input = document.getElementById(`pago_${pago.id}`);
            if (!input) return;
            const monto = input.value;
            if (!monto || parseFloat(monto) <= 0) return;
            formData.append(`pago_${pago.id}`, monto);
        });

        fetch('{% url "cobros:registrar_pagos_multiple" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la red');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(`Pagos registrados correctamente. Total: S/ ${data.total_registrado.toFixed(2)}`);
                
                // Limpiar todo
                pagos = [];
                actualizarLista();
                sessionStorage.removeItem('pagos_multiple');
                formPagos.reset();
                window.location.reload();
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error al registrar pagos. Revisa la consola.');
        });
    });

    // ✅ Contador de caracteres para el campo "notas"
    const notasTextarea = document.getElementById('id_notas');
    const counter = document.getElementById('notas-counter');

    if (notasTextarea && counter) {
        // Mostrar longitud inicial
        counter.textContent = notasTextarea.value.length + '/60';

        // Actualizar al escribir
        notasTextarea.addEventListener('input', function () {
            counter.textContent = this.value.length + '/60';
        });
    }
});
</script>
{% endblock %}